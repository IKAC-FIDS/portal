@{
    ViewBag.PageTitle = "اخبار و اطلاعیه ها";
}

<div class="page-header">
    <a id="CreateButton" class="btn btn-success pull-left">خبر یا اطلاعیه جدید</a>
    <h1>اخبار و اطلاعیه ها</h1>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-striped text-center" id="DataTable">
        <thead>
            <tr>
                <th>عنوان</th>
                <th>تاریخ انتشار</th>
                <th width="1px"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td>
            </tr>
        </tbody>
    </table>
</div>

@section scripts {
    @BundleConfig.AddScripts("~/bundles/newsManageScripts",
        "~/Scripts/jquery.form.js",
        "~/Scripts/jquery.modal.js",
        "~/Scripts/jquery.validate.js",
        "~/Scripts/jquery.validation-extensions.js",
        "~/Scripts/jquery.validation-messages.fa.js",
        "~/Scripts/jquery.confirm.js")

    <script type="text/javascript">
        function loadData() {
            $('#DataTable tbody').empty().append('<tr><td colspan="3"><div class="status-section"><i class="fa fa-spin fa-cog"></i> <p>در حال بارگذاری اطلاعات...</p></div></td></tr>');

            return $.get('@Url.Action("GetData", "News")').done(function (result) {
                $('#DataTable tbody').empty();
                var html = '';

                if (!result.success) {
                    $('#DataTable tbody').empty().append('<tr><td colspan="3"><div class="status-section"><i class="fa fa-frown-o"></i><p>خطا در بارگذاری اطلاعات</p></div></td></tr>');
                    return false;
                }

                if (result.data.length === 0) {
                    $('#DataTable tbody').empty().append('<tr><td colspan="3"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>');
                    return false;
                }

                for (var i = 0; i < result.data.length; i++) {
                    var item = result.data[i];

                    html += '<tr>' +
                        '<td>' + item.title + (item.isMain ? '  <small class="text-success" data-toggle="tooltip" title="نمایش در داشبورد">(<i class="fa fa-star"></i> خبر اصلی)</small>' : '') + '</td>' +
                        '<td>' + item.publishDate + '</td>' +
                        '<td class="text-nowrap">' +
                        '<button data-toggle="tooltip" title="خبر اصلی" data-loading-text="..." data-id="' + item.id + '" class="btn btn-default btn-xs btn-change-status"><i class="fa fa-star"></i></button>&nbsp;' +
                        '<button data-toggle="tooltip" title="ویرایش" data-loading-text="..." data-id="' + item.id + '" class="btn btn-default btn-xs btn-edit"><i class="fa fa-pencil"></i></button>&nbsp;' +
                        '<button data-toggle="tooltip" title="حذف" data-loading-text="..." data-id="' + item.id + '" class="btn btn-danger btn-xs btn-delete"><i class="fa fa-trash"></i></button>' +
                        '</td>' +
                        '</tr>';
                }

                $('#DataTable tbody').empty().append(html);
                $('[data-toggle="tooltip"]').tooltip();
            });
        }

        $(document).ready(function () {
            loadData();

            $('#CreateButton').on('click', function () {
                $.showModal({
                    modalSize: 'xlg',
                    url: '@Url.Action("Create", "News")',
                    onClose: function (modalResult) {
                        if (modalResult === 'ok') {
                            loadData();
                        }
                    }
                });
            });

            $('#DataTable').on('click.btn-edit', '.btn-edit', function () {
                $.showModal({
                    modalSize: 'xlg',
                    url: '@Url.Action("Edit", "News")',
                    data: { id: $(this).data('id') },
                    onClose: function (modalResult) {
                        if (modalResult === 'ok') {
                            loadData();
                        }
                    }
                });
            });

            $('#DataTable').on('click.btn-delete', '.btn-delete', function () {
                var $button = $(this);

                $.showConfirm({
                    onConfirm: function () {
                        $button.button('loading');

                        $.post('@Url.Action("Delete", "News")', { id: $button.data('id') }).done(function (result) {
                            $.processMessage(result);
                            $button.button('reset');

                            if (result.success) {
                                $button.closest('tr').remove();

                                if ($('#DataTable tbody').is(":empty")) {
                                    $('#DataTable tbody').empty().append('<tr><td colspan="3"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>');
                                }
                            }
                        });
                    }
                });
            });

            $('#DataTable').on('click.btn-change-status', '.btn-change-status', function () {
                var $button = $(this);
                $button.button('loading');

                $.post('@Url.Action("ChangeStatus", "News")', { id: $button.data('id') }).done(function (result) {
                    $.processMessage(result);
                    $button.button('reset');

                    if (result.success) {
                        loadData();
                    }
                });
            });
        });
    </script>
}