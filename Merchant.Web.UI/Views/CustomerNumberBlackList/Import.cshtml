@{
    ViewBag.Title = "ورود اطلاعات لیست سیاه مشتریان";
}

<div class="page-header">
    <a class="btn btn-info pull-left" target="_blank" href="~/Download/CustomerNumberBlackList.xlsx">نمونه فایل جهت ورود اطلاعات</a>
    <h1>ورود اطلاعات لیست سیاه مشتریان</h1>
</div>

<form enctype="multipart/form-data" action="@Url.Action("Import", "CustomerNumberBlackList")" method="post" id="CustomerNumberBlackListImportForm">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <div class="fileinput fileinput-new input-group" data-provides="fileinput">
                    <span class="input-group-addon btn btn-default btn-file"><span class="fileinput-new">انتخاب فایل (.xlsx)</span><span class="fileinput-exists">تغییر</span><input accept=".xlsx" type="file" name="File" id="File"></span>
                    <div class="form-control" data-trigger="fileinput">
                        <i class="glyphicon glyphicon-file fileinput-exists"></i> <span class="fileinput-filename"></span>
                    </div>
                    <span class="input-group-btn">
                        <button id="ConfirmButton" type="button" class="btn btn-success" data-loading-text="در حال ثبت...">ثبت اطلاعات</button>
                    </span>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="table-responsive hidden" id="ErrorsSection"></div>

<ul>
    <li><p class="help-block">سطر اول فایل اکسل برای عنوان ستون ها به کار رفته باشد.</p></li>
    <li><p class="help-block">ستون اول فایل اکسل: شماره مشتری</p></li>
    <li><p class="help-block">ستون دوم فایل اکسل: توضیحات</p></li>
</ul>

@section scripts {
    @BundleConfig.AddScripts("~/bundles/customerNumberBlackListImportScripts", 
        "~/Scripts/jasny-bootstrap.js", 
        "~/Scripts/jquery.confirm.js", 
        "~/Scripts/jquery.form.js")

    <script type="text/javascript">
        $(document).ready(function () {
            $('#ConfirmButton').on('click', function (e) {
                if (!$("#File").val()) {
                    toastr.error('فایل مورد نظر را انتخاب نمایید.');
                    return false;
                }

                var $button = $('#ConfirmButton');

                $.showConfirm({
                    onConfirm: function () {
                        var interval = setInterval(function () {
                            toastr.info('اطلاعات در حال ثبت می‌باشد. توجه نمایید که با توجه به حجم اطلاعات ممکن است مدت زمان زیادی برای ثبت صرف شود. لطفاً صبور باشید...');
                        }, 10000);

                        $('#CustomerNumberBlackListImportForm').ajaxSubmit({
                            success: function (result) {
                                clearInterval(interval);
                                $button.button('reset');
                                $.processMessage(result);

                                if (result.success) {
                                    $('#ErrorsSection').addClass('hidden').empty();
                                    window.location.href = '@Url.Action("Manage", "CustomerNumberBlackList")';
                                } else {
                                    clearInterval(interval);
                                    var html = '';
                                    for (var i = 0; i < result.data.length; i++) {
                                        var item = result.data[i];
                                        html += '<div style="margin-top: 15px;" class="alert alert-danger alert-labeled">' +
                                            '<div class="alert-labeled-row"><span class="alert-label alert-labelled-cell">' +
                                            '<i class="fa fa-times"></i></span><p class="alert-labelled-cell alert-body">' + item + '</p>' +
                                            '</div></div>';
                                    }

                                    $('#ErrorsSection').removeClass('hidden').empty().append(html);
                                    $("html, body").animate({ scrollTop: $('#ErrorsSection').offset().top }, 1000);
                                }
                            }, error: function (result) {
                                $button.button('reset');
                                $.processMessage(result);
                                clearInterval(interval);
                            }
                        });

                        $button.button('loading');

                        return false;
                    }
                });
            });
        });
    </script>
}