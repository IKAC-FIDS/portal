@model TerminalManageViewModel

@{
    ViewBag.Title = "مدیریت پذیرندگان";
}

@section styles {
    @BundleConfig.AddStyles("~/Content/terminalManageStyles",
        "~/Content/PersianDatePicker.css",
        "~/Content/chosen.css")
}

<div class="page-header">
    <div class="row">
         
          @*  <div class="col-md-1 pull-left"> *@
          @*                           <a  href="@Url.Action("customerreport", "Terminal", *@
          @*                                         new { IsSpecial=true})" class="btn btn-success pull-left">    مشتریان    ویژه</a> *@
          @*                       </div> *@
          @* <div class="col-md-1 pull-left" style="width:230px" > *@
          @*           <a *@
          @*                *@
          @*               href="@Url.Action("LowTransaction", "Terminal", *@
          @*                         new { ThreeMonthInActive=true})" class="btn btn-success pull-left">     مشتریان زیان ده در سه ماه متوالی</a> *@
          @*       </div> *@
          @*                                        *@
          @*       <div class="col-md-1 pull-left" style="width:220px"> *@
          @*           <a      href="@Url.Action("LowTransaction", "Terminal", *@
          @*                                                                                        *@
          @*                                                   new { TwoMonthInActive=true})"  class=" btn btn-success pull-left">    مشتریان زیان ده در دو ماه متوالی</a> *@
          @*       </div> *@
          @*        *@
          @*     *@
          @*     <div class="col-md-1 pull-left"> *@
          @*                                <a  href="@Url.Action("customerreport", "Terminal" , *@
          @*                                              new { IsGood=true})"  class="btn btn-success pull-left">    مشتریان زیان ده</a> *@
          @*                            </div> *@
          @*       <div class="col-md-1 pull-left"> *@
          @*                                                            <a  href="@Url.Action("TerminalWage", "Terminal", *@
          @*                                                          new { LowTransaction=true})" class="btn btn-success pull-left">    پایانه های زیان ده</a> *@
          @*                                                        </div> *@
          @*        <div class="col-md-1 pull-left"> *@
          @*                            <a    href="@Url.Action("TerminalWage", "Terminal", *@
          @*                                                                                    new {    InActive=true})" class="btn btn-success  pull-left"> پایانه های غیر فعال</a> *@
          @*                        </div> *@
          @*                           *@
          @*        *@
          @*       <div class="col-md-1 pull-left" style="width:180px"> *@
          @*                             <a  href="@Url.Action("TerminalWage", "Terminal", *@
          @*                            new { commaSeparatedStatuses = *@
          @*                         string.Join(",",31, *@
          @*                                    31) })" class="btn btn-success  pull-left">    پایانه های تاخیر در نصب    </a> *@
          @*                   </div>  *@
          @*             *@
                  
            <div class="col-md-3   ">
                <h1>  مدیریت پذیرنده های خارج شبکه    </h1>
            </div>
        </div>
  

  
</div>

<form id="frmSearch" class="form-horizontal">
 
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="control-label col-md-4" for="Year">سال</label>
                <div class="col-md-8">
                                
                    <select id="Year" name="Year" class="form-control">
                        @for (int i = DateTime.Now.GetPersianYear(); i >= 1395; i--)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group">
                <label class="control-label col-md-4" for="Month">ماه</label>
                <div class="col-md-8">
                                               
                    <select id="Month" name="Month" class="form-control">

                        <option value="1">فروردین</option>
                        <option value="2" selected>اردیبهشت</option>
                        <option value="3">خرداد</option>
                        <option value="4">تیر</option>
                        <option value="5">مرداد</option>
                        <option value="6">شهریور</option>
                        <option value="7">مهر</option>
                        <option value="8">آبان</option>
                        <option value="9">آذر</option>
                        <option value="10">دی</option>
                        <option value="11">بهمن</option>
                        <option value="12">اسفند</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row " hidden="hidden">
          <div class="col-md-12">
          <div class="form-group">
             <label class="control-label col-md-2">     پارامتر ها</label>
                                <div class="col-md-10"  >
                                    <div  >
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_hazineh_karmozdShapark" id="p_hazineh_karmozdShapark" checked="checked" 
                                                    >  
                                            کارمزد پرداختی به شرکت شاپرک بابت انجام تراکنش¬های خرید کالا و خدمات
                                        </label>
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_hazineh_rent"  id="p_hazineh_rent" checked="checked"   > 
                                            هزینه پرداختی به شرکت بابت اجاره دستگاه
                                        </label>
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_hazineh_soodePardakty" checked="checked"   id="p_hazineh_soodePardakty"> 
                                            سود پرداختی به سپرده متصل به پایانه فروشگاهی
                                        </label>
                                        
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_hazineh_hashiyeSood" checked="checked"   id="p_hazineh_hashiyeSood"> 
                                                5 درصد کارمزد شرکت شاپرک به‌عنوان حاشیه سود 
                                        </label>
                                        
                                        
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_daramad_Vadie" checked="checked"  id="p_daramad_Vadie"> 
                                                      درآمد حاصل از مبلغ ودیعه         
                                        </label>
                                        
                                        
                                        <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_daramad_Moadel" checked="checked"  id="p_daramad_Moadel"  > 
                                                   درآمد حاصل از معدل سپرده متصل به پایانه‌ فروشگاهی      
                                        </label>
                                        
                                          <label class="btn btn-default  ">
                                            <input type="checkbox" name="p_daramd_Tashilat" checked="checked" id="p_daramd_Tashilat"> 
                                             درآمد حاصل از وثیقه نقدی تسهیلات اعطایی     
                                               </label>
                                    </div>
                                </div>
              </div>
          </div>
</div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="control-label col-md-4" for="TerminalNo">شماره پایانه</label>
                <div class="col-md-8">
                    <input type="text" id="TerminalNo" name="TerminalNo" class="form-control only-number" maxlength="18" />
                </div>
            </div>
        </div>

            <div class="col-md-6">
                     <div class="form-group">
                         <label class="control-label col-md-4">وضعیت زیان ده / سود ده</label>
                         
                         <div class="col-md-8">
                                             
                             <div class="btn-group" data-toggle="buttons">
                                                                        
                                 <label class="btn btn-default "  for="AllTransactionStatus">
                                     <input type="checkbox" name="AllTransactionStatus"  
                                            onchange="handleAllTransactionStatusChanged()" 
                                                             
                                            id="AllTransactionStatus"  /> همه
                                 </label>  </div>
                                        
                             <div class="btn-group" id="TransactionStatusSection" data-toggle="buttons">
                                                                      
                                 <label class="btn btn-default" for="highTransactionStatusList">
                         
                                     <input type="radio" id="highTransactionStatusList"
                                            onchange="highTransactionStatusListChanged()" 
                                                            
                                            name="TransactionStatusList" value="@TransactionStatus.HighTransaction.ToByte()"> سودده
                                 </label>
                                 <label class="btn btn-default"
                                        onchange="highTransactionStatusListChanged()" 
                                        for="lowTransactionStatusList">
                         
                                     <input type="radio" id="lowTransactionStatusList" name="TransactionStatusList" 
                                            value="@TransactionStatus.LowTransaction.ToByte()">    زیان ده
                                 </label>
                             </div>  
                                             
                                             
                         </div>
                         
                     </div>
                 </div>
           </div>
  
 
  

    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <button type="button" id="btnSearch" class="btn btn-primary" data-loading-text="در حال جستجو...">جستجو</button>
            <button type="button" id="btnExport" class="btn btn-default" data-toggle="tooltip" title="دریافت خروجی اکسل موارد یافت شده" data-loading-text="در حال تهیه خروجی. لطفاً منتظر بمانید...">دریافت خروجی</button>
            
        </div>
    </div>
</form>

<hr />

<div id="TotalSearchResultSection"></div>

<br />

<div class="table-responsive">
    <table class="table table-bordered table-striped text-center" id="tblData">
        <thead>
            <tr>
                
               
             
               
                <th class="sortable" data-sort-field="TerminalNo" data-sort-direction="">شماره پایانه</th>
                                <th class="sortable" data-sort-field="pspTitle" data-sort-direction="">Psp</th>

                
                
                <th class="sortable" data-sort-field="AccountNumber" data-sort-direction="">شماره  حساب</th>
                <th class="sortable" data-sort-field="Title" data-sort-direction=""> شعبه  </th>
                
                                <th class="sortable" data-sort-field="transactionValue" data-sort-direction=""> جمع تراکنش  </th>
                                <th class="sortable" data-sort-field="transactionCount" data-sort-direction=""> تعداد تراکنش  </th>

                          <th class="sortable" data-sort-field="Daramad" data-sort-direction=""> درآمد    </th>
                <th class="sortable" data-sort-field="Hazine" data-sort-direction="">هزینه</th> 
                       <th class="sortable" data-sort-field="IsGoodValue" data-sort-direction="">سود / زیان</th> 
                <th class="sortable" data-sort-field="IsGood" data-sort-direction="">    وضعیت    </th>
                
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="15"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="15">
                    <ul id="terminalPagination" class="pagination-sm"></ul>
                </td>
            </tr>
        </tfoot>
    </table>
</div>

<div style="z-index: 10000;" class="modal fade" id="downloadFileModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <p><a class="btn btn-success btn-lg btn-block" id="DownloadFileLink" href="#">دریافت فایل</a></p>
                <button type="button" class="btn btn-default btn-lg btn-block" data-dismiss="modal">انصراف</button>
            </div>
        </div>
    </div>
</div>

<button class="fab-button" id="btnGroupConfirm" data-toggle="tooltip" title="ارسال گروهی">
    ارسال <span id="count"></span> مورد پذیرنده &nbsp;
    <i class="fa fa-send fa-lg"></i>
</button>

@section scripts {
    @BundleConfig.AddScripts("~/bundles/terminalManageScripts",
        "~/Scripts/jquery.twbsPagination.js",
        "~/Scripts/jquery.form.js",
        "~/Scripts/PersianDatePicker.js",
        "~/Scripts/jquery.modal.js",
        "~/Scripts/jquery.validate.js",
        "~/Scripts/jquery.validation-extensions.js",
        "~/Scripts/jquery.validation-messages.fa.js",
        "~/Scripts/jquery.filter_input.js",
        "~/Scripts/jquery.confirm.js",
        "~/Scripts/jasny-bootstrap.js",
        "~/Scripts/chosen.jquery.js",
        "~/Scripts/addressCreator.js")

    <script type="text/javascript">
     function  highTransactionStatusListChanged()
      {
             $('label[for="AllTransactionStatus"]').removeAttr("active");
                     $('label[for="AllTransactionStatus"]').removeClass("active");
                 
                  $('input[name=AllTransactionStatus]:checked', '#frmSearch').prop('checked', false);  
                 
          }
       function  handleAllTransactionStatusChanged()
          {
                $('label[for="highTransactionStatusList"]').removeAttr("active");
                   $('label[for="highTransactionStatusList"]').removeClass("active");
                   
                   $('label[for="lowTransactionStatusList"]').removeAttr("active");
                   $('label[for="lowTransactionStatusList"]').removeClass("active");
                
             $('input[name=TransactionStatusList]:checked', '#frmSearch').prop('checked', false);  
          }
          
          
        function buildSearchParams() {
               var transactionStatusList = [];
                         var terminalTransactionStatusList = [];
                       $('input[name=TransactionStatusList]:checked', '#frmSearch').each(function () {
                           transactionStatusList.push(this.value);
                       });
            $('input[name=TransactionStatusList]:checked', '#frmSearch').each(function () {
                transactionStatusList.push(this.value);
            });
    var terminalTransactionStatusList = [];
         $('input[name=TerminalTransactionStatusList]:checked', '#frmSearch').each(function () {
                        terminalTransactionStatusList.push(this.value);
                    })
            console.log('xcvxcvxcvxvxvxcv',$('input[name=p_hazineh_karmozdShapark]:checked', '#frmSearch').val() == "on");
            
            return {
                statusIdList: $('#StatusIdList', '#frmSearch').val() || [],
                pspId: $('#PspId', '#frmSearch').val(),
                isWireless: $('input[name=IsWireless]:checked', '#frmSearch').val(),
                terminalId: $('#TerminalId', '#frmSearch').val(),
                terminalNo: $('#TerminalNo', '#frmSearch').val(),
                merchantNo: $('#MerchantNo', '#frmSearch').val(),
                Year : $('#Year', '#frmSearch').val(),
                Month :  $('#Month', '#frmSearch').val(),
                changeAccountRequest: $('#ChangeAccountRequest', '#frmSearch').is(':checked'),
                revokeRequest: $('#RevokeRequest', '#frmSearch').is(':checked'),
                marketerId: $('#MarketerId', '#frmSearch').val(),
                deviceTypeId: $('#DeviceTypeId', '#frmSearch').val(),
                isLegalPersonality: $('input[name=IsLegalPersonality]:checked', '#frmSearch').val(),
                
                
                
                p_hazineh_soodePardakty : $('input[name=p_hazineh_soodePardakty]:checked', '#frmSearch').val() == "on" ,
                                p_hazineh_rent : $('input[name=p_hazineh_rent]:checked', '#frmSearch').val() == "on",
                p_hazineh_karmozdShapark : $('input[name=p_hazineh_karmozdShapark]:checked', '#frmSearch').val() == "on",
                p_hazineh_hashiyeSood : $('input[name=p_hazineh_hashiyeSood]:checked', '#frmSearch').val() == "on",
                p_daramad_Vadie : $('input[name=p_daramad_Vadie]:checked', '#frmSearch').val() == "on",
                p_daramad_Moadel : $('input[name=p_daramad_Moadel]:checked', '#frmSearch').val() == "on",
                p_daramd_Tashilat : $('input[name=p_daramd_Tashilat]:checked', '#frmSearch').val() == "on",

                  transactionStatusList: transactionStatusList,
          
            terminalTransactionStatusList: terminalTransactionStatusList,
                title: $('#Title', '#frmSearch').val(),
                nationalCode: $('#NationalCode', '#frmSearch').val(),
                isMale: $('input[name=IsMale]:checked', '#frmSearch').val(),
             
                
                mobile: $('#Mobile', '#frmSearch').val(),
                fromSubmitTime: $('#FromSubmitTime', '#frmSearch').val(),
                toSubmitTime: $('#ToSubmitTime', '#frmSearch').val(),
                fromInstallationDate: $('#FromInstallationDate', '#frmSearch').val(),
                toInstallationDate: $('#ToInstallationDate', '#frmSearch').val(),
                fromBatchDate: $('#FromBatchDate', '#frmSearch').val(),
                toBatchDate: $('#ToBatchDate', '#frmSearch').val(),
                fromRevokeDate: $('#FromRevokeDate', '#frmSearch').val(),
                toRevokeDate: $('#ToRevokeDate', '#frmSearch').val(),
                fromTransactionCount: $('#FromTransactionCount', '#frmSearch').val(),
                toTransactionCount: $('#ToTransactionCount', '#frmSearch').val(),
                fromTransactionPrice: $('#FromTransactionPrice', '#frmSearch').val(),
                toTransactionPrice: $('#ToTransactionPrice', '#frmSearch').val(),
                fromTransactionDate: $('#FromTransactionDate', '#frmSearch').val(),
                toTransactionDate: $('#ToTransactionDate', '#frmSearch').val(),
                customerNumber: $('#CustomerNumber', '#frmSearch').val(),
                justActive: $('input[name=JustActive]:checked', '#frmSearch').val(),
                fullName: $('#FullName', '#frmSearch').val(),
                taxPayerCode: $('#TaxPayerCode', '#frmSearch').val(),
                IsGood: $('input[name=p_daramd_Tashilat]:checked', '#frmSearch').val() == "on",
                //justVip: $('#input[name=JustVip]:checked', '#frmSearch').val()
            };
        }

        function getPsp(pspid)
        {switch(pspid) {
           case "581672011":
               return "آپ";
             break;
              case "581672021":
                   case "581672022":
                        return "الکترونیک کارت دماوند";
           
             break;
               case "581672031":
                           return "به پرداخت";
                          break;
       case "581672041":
     case "581672042":                                                       
 case "581672043":
 return "سامان";
 
 case "581672051" :
     case "581672052":
          return "پرداخت نوین";
      case "581672061" :
          case "581672062":
                 return "تاپ";
               case "581672081" :
                     case "581672082":
                       return "  امید پی";
                        case "581672091":
                                             return "فن آوا کارت";
                         case "581672111":
                                  case "581672112":
                                return "ایران کیش";
                                case "581672131" : 
                                    case "581672132" : 
                                         return "سداد";
                                 case "581672121":
                                                   return "سپهر";
                                                      case "581672141":
                                                                   return "پاسارگاد";
                                                                     case "581672142":
                                                                                   return "پاسارگاد";
                                                                                      case "1":
                                                                                                   return "فن آوا کارت";
                                                                                               case "2":
                                                                                                   return "ایران کیش";
                                                                                               case "3":
                                                                                                   return "پارسیان";
                                                                                             
           default:
             return "دیگر"
         } 
            }
        function loadData(retriveTotalPageCount, page) {
            if ($('input[name=TransactionStatusList]:checked').length && !$('#FromTransactionDate', '#frmSearch').val()) {
             //   toastr.warning('در صورت انتخاب وضعیت فعالیت پایانه از تاریخ تراکنش نیز بایستی وارد لطفاً از تاریخ تراکنش را وارد نمایید');
             //   return false;
            }

            var sortColumn = $('#tblData th.active');
            var orderClause = '';

            if (sortColumn.length) {
                orderClause = sortColumn.data('sort-field') + ' ' + sortColumn.data('sort-direction');
            }

            $('#btnGroupConfirm').fadeOut();
            $('#tblData tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-spin fa-cog"></i> <p>در حال بارگذاری اطلاعات...</p></div></td></tr>');

            if (retriveTotalPageCount) {
                var pagingData = $('#terminalPagination').data('twbs-pagination');
                if (pagingData) $('#terminalPagination').twbsPagination('destroy');
                $('#btnSearch').removeData('total-pages');
            }

            $('#SelectAllTerminals').attr('checked', false);
            $('#SelectAllTerminals').trigger('change');

            var $searchButton = $('#btnSearch');
            $searchButton.button('loading');

            var params = $.extend({ retriveTotalPageCount: retriveTotalPageCount, page: page, orderByColumn: orderClause }, buildSearchParams());

            return $.post('@Url.Action("OutOfNetworkTerminals", "Terminal")', params).done(function (result) {
                $searchButton.button('reset');
                $('#tblData tbody').empty();
                $('#TotalSearchResultSection').empty();
                var html = '';

                if (!result.success) {
                    $('#tblData tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-frown-o"></i><p>خطا در بارگذاری اطلاعات</p></div></td></tr>');
                    return false;
                }

                if (result.data.rows.length === 0) {
                    $('#tblData tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>');
                    return false;
                }

                if (retriveTotalPageCount) {
                    $('#TotalSearchResultSection').empty().append('<b>تعداد موارد یافت شده: </b>' + convertToPersianNumbers(result.data.totalRowsCount) + ' مورد');
                } else {
                    $('#TotalSearchResultSection').empty();
                }

                if (retriveTotalPageCount && result.data.totalRowsCount > 0) {
                    $('#btnSearch').data('total-pages', result.data.totalRowsCount);

                    $('#terminalPagination').twbsPagination({
                        totalPages: Math.ceil(result.data.totalRowsCount / 300),
                        visiblePages: 7,
                        last: '<i class="fa fa-fast-backward"></i>',
                        next: '<i class="fa fa-backward"></i>',
                        prev: '<i class="fa fa-forward"></i>',
                        first: '<i class="fa fa-fast-forward"></i>',
                        initiateStartPageClick: false,
                        onPageClick: function (event, page) {
                            loadData(false, page);
                        }
                    });
                }

                for (var i = 0; i < result.data.rows.length; i++) {
                    var item = result.data.rows[i];

                    html += '<tr data-terminal-id="' + item.terminalId + '" data-status-id="' + item.statusId + '">' +
                          
                 
                        '<td>' + (item.terminalNo ) + '</td>' +
                          
                            '<td>' + (item.pspId  == null ? " " :getPsp( item.pspId)) + '</td>' +
                                '<td>' + (item.accountNumber  == null ? " " : item.accountNumber) + '</td>' +
                                    '<td>' + (item.title ) + '</td>' +
                                        '<td>' +convertToPersianNumbersThreeDigitsSeparated (item.transactionValue  == null ? " " : item.transactionValue) + '</td>' +
                                            '<td>' + (item.transactionCount  == null ? " " : item.transactionCount) + '</td>' +
                             '<td>' + convertToPersianNumbersThreeDigitsSeparated (item.daramad  )    + '</td>' +
                            '<td>' +  convertToPersianNumbersThreeDigitsSeparated(item.hazine  )    + '</td>' +      
                                         '<td style="direction:ltr;color: ' +   (item.isGoodValue > 0 ?'green"': 'red"') + '>' + convertToPersianNumbersThreeDigitsSeparated (item.isGoodValue  )    + '</td>' +                          
                                                 '<td >' +( item.isGood == null ? "-" : ( item.isGood ? "سودده" : "زیان ده")) + '</td>' 
                  
                    html += '</tr>';
                }

                $('#tblData tbody').empty().append(html);
                $('[data-toggle="tooltip"]').tooltip();
            });
        }
        
         function createTransactionStatusIcon2(transactionStatusId) {
                    var color, shortTitle;
        
                    console.log("'inja'" + transactionStatusId)
                    if ( transactionStatusId == false )
                        {
                             shortTitle = 'پر تراکنش';
                                            color = '#28874a';
                      }
                         else if(transactionStatusId)
                               
                                             {
                                                  shortTitle = 'کم تراکنش';
                                                                 color = '#9E9E9E';
                                           }
                         else
                             {
                                   shortTitle = '-';
                                   color = '#9E9E9E';
                                 }
                   
        
                    return transactionStatusId ? '<small style="font-weight: bold; color: ' + color + ';">' + shortTitle + '</small>' : 
                     '<small style="font-weight: bold; color: ' + color + ';">' + shortTitle + '</small>' ;
                }

  function getActiveStatus(isActive) {
                    var color, shortTitle;
        
                    console.log('xzcvzxcvzxcvzxvc',isActive);
                    
                    if (isActive   )
                        {
                             shortTitle = '  فعال';
                                            color = '#28874a';
                      }
                    else if( isActive  == false )
                           {
                                 shortTitle = 'غیر فعال';
                        color = '#9E9E9E';
                           }
                   else 
         {
                                         shortTitle = '-';
                                color = '#9E9E9E';
                                   }
                    return isActive ? '<small style="font-weight: bold; color: ' + color + ';">' + shortTitle + '</small>' :
                     '<small style="font-weight: bold; color: ' + color + ';">' + shortTitle + '</small>' ;
                }

        function showDetailsButton(statusId, terminalId) {
            return '<button data-toggle="tooltip" title="مشاهده اطلاعات کامل" data-terminal-id="' + terminalId + '" class="btn btn-default btn-xs btn-details"><i class="fa fa-eye"></i></button> &nbsp;';
        }

        function showTransactionsButton(terminalNo) {
            return (terminalNo && terminalNo.match(/^ *$/) === null) ? '<button data-toggle="tooltip" title="تراکنش ها" data-terminal-no="' + terminalNo + '" class="btn btn-default btn-xs btn-transactions"><i class="fa fa-exchange"></i></button> &nbsp;' : '';
        }

        function showDeleteButton(statusId, terminalId) {
            if ((@JsonNet.Encode(User.IsAdmin()) && (statusId == '@TerminalStatus.New.ToByte()' || statusId == '@TerminalStatus.NeedToReform.ToByte()' || statusId == '@TerminalStatus.NotReturnedFromSwitch.ToByte()')) || (@JsonNet.Encode(User.IsAcceptorsExpertUser()) && statusId === @TerminalStatus.New.ToByte())) {
                return '<button data-loading-text="..." data-toggle="tooltip" title="حذف" data-terminal-id="' + terminalId + '" class="btn btn-danger btn-xs btn-delete"><i class="fa fa-trash"></i></button> &nbsp;';
            } else {
                return '';
            }
        }

        function showNotesButton(terminalId) {
            return '<button data-terminal-id="' + terminalId + '" data-toggle="tooltip" data-loading-text="..." title="یادداشت ها" class="btn btn-default btn-xs btn-notes"><i class="fa fa-commenting"></i></button> &nbsp;';
        }

        //function showToggleVipButton(terminalId) {
        //    return '<button data-terminal-id="' + terminalId + '" data-toggle="tooltip" data-loading-text="..." title="اضافه / حذف از موارد ویژه" class="btn btn-warning btn-xs btn-toggle-vip"><i class="fa fa-star"></i></button>';
        //}

function showStatusRequestButton( terminalId,topiarId, pspId,statusId)
{
        console.log('showstatus',terminalId,topiarId, topiarId !== null)

    
    if (pspId == 3)
        {
            if ( topiarId !== null && statusId != 16 && statusId != 9)
                {
     return '<button data-topiar-id="' + topiarId +   '" data-terminal-id="' + terminalId + '" data-toggle="tooltip"' +
      ' data-loading-text="..." title="استعلام وضعیت" style="background-color:dodgerblue" class="btn btn-success btn-xs btn-getTerminalStatus"><i class="fa fa-info-circle"></i></button> &nbsp;';

                    
                    }
            else if (statusId !==  4  && statusId != 16 && statusId != 9 )
                {
        
                    return '<button    data-terminal-id="' + terminalId + '" data-toggle="tooltip"' +
                          ' data-loading-text="..." title="استعلام وضعیت" ' +

                           'style="background-color:dodgerblue" class="btn btn-success btn-xs btn-getRequestStatus"><i class="fa fa-info-circle"></i></button> &nbsp;';

                    
                    }
            else return  ''
            
            }
    else
        {
            return  ''
            }
    
    
    }

        function showConfirmButton(statusId, fullName, nationalCode, accountNo, shebaNo, terminalId) {
            if (@JsonNet.Encode(User.IsAcceptorsExpertUser()) && (statusId === @TerminalStatus.NeedToReform.ToByte() || statusId === @TerminalStatus.UnsuccessfulReturnedFromSwitch.ToByte())) {
                return '<button data-full-name="' + fullName + '" data-national-code="' + convertToPersianNumbers(nationalCode) + '" data-account-number="' + convertToPersianNumbers(accountNo) + '" data-sheba-number="' + convertToPersianNumbers(shebaNo) + '" data-terminal-id="' + terminalId + '" data-toggle="tooltip" data-loading-text="..." title="تایید" class="btn btn-success btn-xs btn-confirm"><i class="fa fa-check"></i></button> &nbsp;';
            } else {
                return '';
            }
        }
function showDamageRequestButton(statusId, terminalNo,terminalId) {
             if (@JsonNet.Encode(User.IsAcceptorsExpertUser() || User.IsAdmin())
                         && (  statusId !== @TerminalStatus.Deleted.ToByte())) {
       return '<button data-toggle="tooltip" title="اعلام خسارت    " data-terminal-id="' + terminalId + '" class="btn btn-default btn-xs btn-damage-request">' +
        '<i class="fa fa-diamond"></i></button> &nbsp;';
}
             else
                 return  '';
              }
        function showRequestsButton(statusId, terminalNo,terminalId) {
            if (@JsonNet.Encode(User.IsAcceptorsExpertUser() || User.IsBranchUser() || User.IsItUser())
             && (terminalNo && terminalNo.match(/^ *$/) === null && statusId === @TerminalStatus.Installed.ToByte())) {
                return '<div class="btn-group"><button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ثبت درخواست <span class="caret"></span></button><ul class="dropdown-menu">' +
                    '<li><a class="btn-change-account-request" data-terminal-number="' + terminalNo + '">تغییر حساب</a></li>' +
                    '<li><a class="btn-revoke-request" data-terminal-number="' + terminalNo + '">جمع آوری</a></li>' +
                                                    
                    '</ul></div> &nbsp;';
            } 
          
            else {
                return '';
            }
        }

        function showEditButton(statusId, terminalId, marketerId) {
            if (@JsonNet.Encode(User.IsAcceptorsExpertUser() || User.IsBranchUser() || User.IsItUser())) {
                if (statusId === @TerminalStatus.New.ToByte() || statusId === @TerminalStatus.NeedToReform.ToByte() || statusId == @TerminalStatus.UnsuccessfulReturnedFromSwitch.ToByte()) {

                    if (@User.IsBranchUser().ToString().ToLower()) {
                        if (marketerId === @Marketer.BankOrBranch.ToByte() && statusId != @TerminalStatus.UnsuccessfulReturnedFromSwitch.ToByte()) {
                            return '<button data-terminal-id="' + terminalId + '" data-toggle="tooltip" title="ویرایش" class="btn btn-default btn-xs btn-edit"><i class="fa fa-pencil"></i></button> &nbsp;';
                        } else {
                            return '';
                        }
                    } else {
                        return '<button data-terminal-id="' + terminalId + '" data-toggle="tooltip" title="ویرایش" class="btn btn-default btn-xs btn-edit"><i class="fa fa-pencil"></i></button> &nbsp;';
                    }
                } else {
                    return '';
                }
            } else {
                return '';
            }
        }

        $('.date-picker').on('click', function () {
            PersianDatePicker.Show(this, '@DateTime.Now.ToPersianDate()', true);
        });

        function createStatusIcon(statusId, statusTitle, submitterUserFullName) {
            var statusColor = '#D7CCC8';
            switch (statusId) {
                case @TerminalStatus.New.ToByte():
                    statusColor = '#FFC107';
                    break;
                case @TerminalStatus.NotReturnedFromSwitch.ToByte():
                    statusColor = '#607D8B';
                    break;
                case @TerminalStatus.NeedToReform.ToByte():
                    statusColor = '#009688';
                    break;
                case @TerminalStatus.ReadyForAllocation.ToByte():
                    statusColor = '#CDDC39';
                    break;
                case @TerminalStatus.Allocated.ToByte():
                    statusColor = '#8BC34A';
                    break;
                case @TerminalStatus.Test.ToByte():
                    statusColor = '#03A9F4';
                    break;
                case @TerminalStatus.Installed.ToByte():
                    statusColor = '#4CAF50';
                    break;
                case @TerminalStatus.Revoked.ToByte():
                    statusColor = '#f44336';
                    break;
                case @TerminalStatus.UnsuccessfulReturnedFromSwitch.ToByte():
                    statusColor = '#00BFA5';
                    break;
            }

            return '<span style="background-color: ' + statusColor + '; font-weight: 500;" data-toggle="tooltip" title="' + submitterUserFullName + '" class="label label-default">' + statusTitle + '</span>';
        }

        function createPspIcon(pspId, pspTitle) {
            var pspColor, pspShortTitle;

            switch (pspId) {
                case @PspCompany.Fanava.ToByte():
                    pspShortTitle = 'FA';
                    pspColor = '#5C6BC0';
                    break;
                case @PspCompany.IranKish.ToByte():
                    pspShortTitle = 'IK';
                    pspColor = '#E91E63';
                    break;
                case @PspCompany.Parsian.ToByte():
                    pspShortTitle = 'PA';
                    pspColor = '#FFB300';
                    break;
                      case @PspCompany.PardakhNovin.ToByte():
                                                                    pspShortTitle = 'PN';
                                                                    pspColor = '#0f4158';
                                                                    break;
                default:
                    pspShortTitle = '??';
                    pspTitle = 'تخصیص داده نشده';
                    pspColor = '#9E9E9E';
                    break;
            }

            return '<span style="background-color: ' + pspColor + '; font-weight: 500;" data-toggle="tooltip" title="' + pspTitle + '" class="label label-default small-label">' + pspShortTitle + '</span>';
        }

        function createTransactionStatusIcon(transactionStatusId) {
            var color, shortTitle;

            switch (transactionStatusId) {
            case @TransactionStatus.HighTransaction.ToByte():
                shortTitle = 'پُر تراکنش';
                color = '#009688';
                break;
            case @TransactionStatus.LowTransaction.ToByte():
                shortTitle = 'کم تراکنش';
                color = '#9E9E9E';
                break;
            case @TransactionStatus.WithoutTransaction.ToByte():
                shortTitle = 'فاقد تراکنش';
                color = '#E91E63';
                break;
            default:
                shortTitle = 'نامشخص';
                color = '#CFD8DC';
                break;
            }

            return transactionStatusId ? '<small style="font-weight: bold; color: ' + color + ';">' + shortTitle + '</small>' : '';
        }

        function refreshCurrentPage(){
            var currentPageNo = $('#terminalPagination li.page.active').data('page');
            loadData(false, currentPageNo);
        }

        function showEditDialog(terminalId) {
            $.showModal({
                modalSize: 'xlg',
                url: '@Url.Action("Edit", "Terminal")',
                data: { terminalId: terminalId },
                onClose: function (modalResult) {
                    if (modalResult === 'ok') {
                        refreshCurrentPage();
                    }
                }
            });
        }

        function showBlockDocumentEditDialog(terminalId) {
            $.showModal({
                modalSize: 'lg',
                url: '@Url.Action("Edit", "BlockDocument")',
                data: { terminalId: terminalId }
            });
        }

        $(document).ready(function () {
            @if (!string.IsNullOrEmpty(Model.CommaSeparatedStatuses))
            {
                var commaSeparatedValues = JsonNet.Encode(Model.CommaSeparatedStatuses.GetCommaSeparatedValues().ToArray());
                <text>
                    $('#StatusIdList').val(@commaSeparatedValues).trigger("chosen:updated");
                </text>
            }

            loadData(true, 1);

            $('#SelectAllTerminals').on('change', function () {
                if (this.checked) {
                    $('.send-to-psp').prop('checked', true).trigger('change');
                } else {
                    $('.send-to-psp').prop('checked', false).trigger('change');
                }
            });

            $('#tblData').on('change', 'tbody .send-to-psp', function () {
                var $row = $(this).closest('tr');

                if (this.checked) {
                    $row.addClass('info');
                } else {
                    $row.removeClass('info');
                }

                if ($('#tblData tbody tr.info').length) {
                    $('#btnGroupConfirm').fadeIn();
                    $('#btnGroupConfirm #count').empty().append(convertToPersianNumbers($('#tblData tbody tr.info').length));
                } else {
                    $('#btnGroupConfirm').fadeOut();
                }
            });

            $('#btnGroupConfirm').on('click', function () {
                $.showModal({
                    url: '@Url.Action("GroupConfirm", "Terminal")',
                    onClose: function (modalResult) {
                        if (modalResult === 'ok') {
                            $('#btnGroupConfirm').fadeOut();
                            loadData(true, 1);
                        }
                    }
                });
            });

            $('#tblData th.sortable').on('click', function () {
                var sortDirection = $(this).data('sort-direction');

                $('#tblData th').removeClass('active');
                $('#tblData th').find('i').remove();

                if (!sortDirection) {
                    sortDirection = 'ASC';
                    $(this).addClass('active');
                    $(this).append('<i class="fa fa-chevron-up"></i>');
                } else if (sortDirection === 'ASC') {
                    sortDirection = 'DESC';
                    $(this).addClass('active');
                    $(this).append('<i class="fa fa-chevron-down"></i>');
                } else if (sortDirection === 'DESC') {
                    sortDirection = '';
                    $(this).removeClass('active');
                }

                $(this).data('sort-direction', sortDirection);
                loadData(false, 1);
            });

            $('.only-number', '#frmSearch').filter_input({ regex: '[0-9]' });
          
            $('#StatusIdList').chosen({ width: "100%", rtl: true });


           

            $('#btnClearSearchFilters').on('click', function () {
                $('input:text', '#frmSearch').val('');
                $('select', '#frmSearch').val('');
                $('#PspId', '#frmSearch').val('@PspCompany.All.ToInt32()');
                $('#LegalPersonalityAll', '#frmSearch').click();
                $('#GenderAll', '#frmSearch').click();
                $('#AllTransactionStatuses', '#frmSearch').click();
                $('#IsWirelessAll', '#frmSearch').click();
                $('#TransactionStatusSection', '#frmSearch').find('label').removeClass('active');
                $('#TransactionStatusSection', '#frmSearch').find('input[type="checkbox"]').removeAttr('checked');
                $('#RequestsSection', '#frmSearch').find('label').removeClass('active');
                $('#RequestsSection', '#frmSearch').find('input[type="checkbox"]').removeAttr('checked');
            
                $('#StatusIdList', '#frmSearch').val('').trigger("chosen:updated");
                $('#All', '#frmSearch').click();
            });
 

         
            $('#tblData').on('click.btn-details', '.btn-details', function () {
                var terminalId = $(this).data('terminal-id');

                console.log('bababa',  $('#FromTransactionDate', '#frmSearch').val());
                $.showModal({
                    modalSize: 'lg',
                    url: '@Url.Action("Details", "Terminal")',
                    data: { terminalId: terminalId, from : 
                    $('#FromWageTransactionDate', '#frmSearch').val()
                    
                    ,to:   $('#ToWageTransactionDate', '#frmSearch').val() },
                    onClose: function (modalResult) {
                        if (modalResult === 'ok') {
                            loadData(true, 1);
                        } else if (modalResult == 'showEdit') {
                            showEditDialog(terminalId);
                        } else if (modalResult == 'showBlockDocumentEdit') {
                            showBlockDocumentEditDialog(terminalId);
                        }
                    }
                });
            });

            $('#tblData').on('click.btn-notes', '.btn-notes', function () {
                var terminalId = $(this).data('terminal-id');

                $.showModal({
                    modalSize: 'lg',
                    url: '@Url.Action("Index", "TerminalNote")',
                    data: { terminalId: terminalId }
                });
            });

            $('#tblData').on('click.btn-transactions', '.btn-transactions', function () {
                $.showModal({
                    modalSize: 'xlg',
                    url: '@Url.Action("Index", "Transaction")',
                    data: { terminalNo: $(this).data('terminal-no') }
                });
            });

            $('#tblData').on('click.btn-change-account-request', '.btn-change-account-request', function () {
                $.showModal({
                    modalSize: 'md',
                    url: '@Url.Action("Create", "ChangeAccountRequest")',
                    data: { terminalNo: $(this).data('terminal-number') }
                });
            });

            $('#tblData').on('click.btn-revoke-request', '.btn-revoke-request', function () {
                $.showModal({
                    modalSize: 'lg',
                    url: '@Url.Action("Create", "RevokeRequest")',
                    data: { terminalNo: $(this).data('terminal-number') }
                });
            });
          $('#tblData').on('click.btn-damage-request', '.btn-damage-request', function () {
             
                $.showModal({
                    modalSize: 'lg',
                    url: '@Url.Action("Create", "PropertyDamageRequest")',
                    data: { terminalId: $(this).data('terminal-id') }
                });
            });
            $('#tblData').on('click.btn-edit', '.btn-edit', function () {
                showEditDialog($(this).data('terminal-id'));
            });

            
            $('#tblData').on('click.btn-confirm', '.btn-confirm', function () {
                            var $button = $(this);
            
                            $.showConfirm({
                                body: '<strong>نام و نام خانوادگی: </strong> <span>' + $button.data('full-name') + '</span><br /><br /><strong>کد ملی: </strong> <span>' + $button.data('national-code') + '</span><br /><br /><strong>شماره حساب: </strong> <span dir="ltr">' + $button.data('account-number') + '</span><br /><br /><strong>شبا: </strong> <span>' + $button.data('sheba-number') + '</span>',
                                onConfirm: function () {
                                    $button.button('loading');
            
                                    $.post('@Url.Action("Confirm", "Terminal")', { terminalId: $button.data('terminal-id') }).done(function (result) {
                                        $.processMessage(result);
                                        $button.button('reset');
            
                                        if (result.success) {
                                            refreshCurrentPage();
                                        }
                                    });
                                }
                            });
                        });

            
            $('#tblData').on('click.btn-getTerminalStatus', '.btn-getTerminalStatus', function () {
               
                 let terminalId = $(this).data('terminal-id');
                                 let topiarId = $(this).data('topiar-id');

                                $.showModal({
                                    modalSize: 'lg',
                                    url: '@Url.Action("GetRequestStatus", "Terminal")',
                                    data: {topiarId : topiarId, TerminalId: terminalId },
                                    onClose: function (modalResult) {
                                        
                                        console.log('asdfasdfasdf',modalResult);
                                        
                                        if (modalResult === 'ok') {
                                            loadData(true, 1);
                                        } else if (modalResult == 'showEdit') {
                                            showEditDialog(terminalId);
                                        } else if (modalResult == 'showBlockDocumentEdit') {
                                            showBlockDocumentEditDialog(terminalId);
                                        }
                                    }
                                });
            });
            
            
            $('#tblData').on('click.btn-getRequestStatus', '.btn-getRequestStatus', function () {
           
                console.log('asdfasdfasdfeeee');
            let terminalId = $(this).data('terminal-id');
                                           let topiarId = $(this).data('topiar-id');
                console.log('asdfasdfasdfeeee',topiarId,terminalId);

  
                                $.showModal({
                                    modalSize: 'lg',
                                    url: '@Url.Action("GetRequestStatus", "Terminal")',
                                    data: {topiarId : 0, TerminalId: terminalId },
                                    onClose: function (modalResult) { 
                                                                            console.log('asdfasdfasdf2',modalResult);

                                        if (modalResult === 'ok') {
                                            loadData(true, 1);
                                        } else if (modalResult == 'showEdit') {
                                            showEditDialog(terminalId);
                                        } else if (modalResult == 'showBlockDocumentEdit') {
                                            showBlockDocumentEditDialog(terminalId);
                                        }
                                    }
                                });
                                
            });

            $('#tblData').on('click.btn-delete', '.btn-delete', function () {
                var $button = $(this);

                $.showConfirm({
                    onConfirm: function () {
                        $button.button('loading');

                        $.post('@Url.Action("Delete", "Terminal")', { terminalId: $button.data('terminal-id') }).done(function (result) {
                            $button.button('reset');
                            $.processMessage(result);

                            if (result.success) {
                                $button.closest('tr').remove();

                                if ($('#tblData tbody').is(":empty")) {
                                    $('#tblData tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>');
                                    $('#Pagination').twbsPagination('destroy');
                                }
                            }
                        });
                    }
                });
            });

            @*$('#tblData').on('click.btn-toggle-vip', '.btn-toggle-vip', function () {
                var $button = $(this);

                $.showConfirm({
                    onConfirm: function () {
                        $button.button('loading');

                        $.post('@Url.Action("ToggleVip", "Terminal")', { terminalId: $button.data('terminal-id') }).done(function (result) {
                            $button.button('reset');
                            $.processMessage(result);

                            if (result.success) {
                                refreshCurrentPage();
                            }
                        });
                    }
                });
            });*@

            $('#DownloadFileLink').click(function() {
                $('#downloadFileModal').modal('hide');
            });

            $('#btnExport').on('click', function () {
                var $exportButton = $(this);
                $exportButton.button('loading');

                $.post('@Url.Action("ExportBiResultByParametersDataOutOfNetwork", "Export")', buildSearchParams()).done(function (result) {
                    $.processMessage(result);
                    $exportButton.button('reset');

                    if (result.success) {
                        var $downloadLink = $('#downloadFileModal .modal-body a');
                        $downloadLink.prop('href', '@Url.Action("DownloadTerminalOutputFile", "Export")?fileKey=' + result.data);
                        $('#downloadFileModal').modal();
                    }
                });
            });

            $('#btnSearch').on('click', function () {
                loadData(true, 1);
            });

            $('.btn-filter-status').on('click', function () {
                var statusIdList = $(this).data('status-id').split(',').map(Number);
                $('#StatusIdList').val(statusIdList).trigger("chosen:updated");
                loadData(true, 1);

                $('html, body').animate({
                    scrollTop: $("#tblData").offset().top
                }, 600);
            });
        });
    </script>
}