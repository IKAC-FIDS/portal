@{
    ViewBag.Title = "گزارش وضعیت درخواست ها";
}

<div class="page-header">
    <h1>گزارش وضعیت درخواست ها</h1>
</div>

<div class="form-horizontal" id="SearchForm">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label class="control-label col-md-4" for="BranchId">کد شعبه</label>
                <div class="col-md-8">
                    <input type="text" id="BranchId" name="BranchId" class="form-control only-number" maxlength="10" />
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label class="control-label col-md-4" for="BranchTitle">نام شعبه</label>
                <div class="col-md-8">
                    <input type="text" id="BranchTitle" name="BranchTitle" class="form-control" maxlength="100" />
                </div>
            </div>
        </div>

        <div class="form-group">
            <button type="button" id="btnSearch" class="btn btn-primary" data-loading-text="در حال جستجو...">جستجو</button>
            <button type="button" id="btnExport" class="btn btn-default" data-loading-text="در حال تهیه خروجی. لطفاً منتظر بمانید...">دریافت خروجی</button>
        </div>
    </div>
</div>

<hr />

<div class="alert alert-info">
    در این گزارش درخواست‌های جمع آوری یا نصب پایانه هایی که از سوی شعب در پورتال مدیریت پذیرندگان ثبت گردیده است، بلافاصله در محاسبه آمار نسبت 30 به 70 درصد دستگاه‌های سیار و ثابت شعبه مربوطه و بدون احتساب دستگاه‌های بازاریابی شده توسط شرکت تجارت الکترونیک سرمایه لحاظ می گردد.
</div>

<div><b>تعداد شعب مجاز به ثبت درخواست پایانه فروش بی سیم: </b> <span id="AllowWirelessCount"></span></div>
<br />
<div><b>تعداد شعب غیر مجاز به ثبت درخواست پایانه فروش بی سیم: </b> <span id="NotAllowWirelessCount"></span></div>

<br />

<div class="table-responsive">
    <table class="table table-bordered text-center" id="DataTable">
        <thead>
            <tr class="active">
                <th>ردیف</th>
                <th width="1px">کد شعبه</th>
                <th>نام شعبه</th>
                <th>تعداد دستگاه های کارتخوان</th>
                <th>تعداد دستگاه ثابت</th>
                <th>تعداد دستگاه سیار</th>
                <th>دستگاه ثابت (درصد)</th>
                <th>دستگاه سیار (درصد)</th>
                <th>مجاز به ثبت درخواست بیسیم</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="15"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>
        </tbody>
    </table>
</div>
@section scripts {
    <script type="text/javascript">
        function loadData() {
            $('#DataTable tbody').empty();

            var html = '<tr><td colspan="15"><div class="status-section"><i class="fa fa-spin fa-cog"></i> <p>در حال بارگذاری اطلاعات...</p></div></td></tr>';
            $('#DataTable tbody').append(html);
            var branchId = $('#BranchId', '#SearchForm').val();
            var branchTitle = $('#BranchTitle', '#SearchForm').val();

            $.getJSON('@Url.Action("GetTerminalTypesData", "Report")', { branchId: branchId, branchTitle: branchTitle })
                .done(function (result) {
                    $.processMessage(result);
                    $('#DataTable tbody').empty();

                    if (!result.success) {
                        $('#DataTable tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-frown-o"></i><p>خطا در بارگذاری اطلاعات</p></div></td></tr>');
                        return false;
                    }

                    if (result.data.length === 0) {
                        $('#DataTable tbody').empty().append('<tr><td colspan="15"><div class="status-section"><i class="fa fa-folder-o"></i><p>هیچ موردی یافت نشد</p></div></td></tr>');
                        return false;
                    }

                    html = '';

                    $('#AllowWirelessCount').empty().append($.grep(result.data, function (item, index) { return item.allowWireless; }).length);
                    $('#NotAllowWirelessCount').empty().append($.grep(result.data, function (item, index) { return !item.allowWireless; }).length);

                    for (var i = 0; i < result.data.length; i++) {
                        html += '<tr>' +
                            '<th class="text-nowrap">' + (i + 1) + '</th>' +
                            '<th class="text-nowrap">' + (result.data[i].id || '') + '</th>' +
                            '<td>' + (result.data[i].title || '') + '</td>' +
                            '<td>' + result.data[i].totalCount + '</td>' +
                            '<td>' + result.data[i].withWireCount + '</td>' +
                            '<td>' + result.data[i].wirelessCount + '</td>' +
                            '<td>' + result.data[i].withWirePercentage + ' %</td>' +
                            '<td>' + result.data[i].wirelessPercentage + ' %</td>' +
                            '<td class="' + (result.data[i].allowWireless ? 'success text-success' : 'warning text-danger') + '">' + (result.data[i].allowWireless ? 'بله' : 'خیر') + '</td>' +
                            '</tr>';
                    }

                    $('#DataTable tbody').append(html);
                });
        }
        $(document).ready(function () {
            loadData();

            $('#btnSearch').on('click', function () {
                loadData();
            });

            $('#btnExport').on('click', function () {
                var params = '?branchId=' + $('#BranchId').val() +
                    '&branchTitle=' + $('#BranchTitle').val();

                $('#btnExport').prop('href', '@Url.Action("DownloadTerminalTypesData", "Report")' + params);
                window.location.href = ('@Url.Action("DownloadTerminalTypesData", "Report")' + params);
            });
        });
    </script>
}
